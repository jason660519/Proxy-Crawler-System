---
title: URL_2_parquet_ETL.py 設計細節說明書
lastUpdated: 2025-09-08
---

import React from 'react'

# URL_2_parquet_ETL 設計細節（UI/UX × 流程 × 技術映射）

目標：把「URL → HTML → Markdown → JSON → CSV → Parquet」的五段式流程，封裝成使用者只需輸入 URL、即可一鍵取得所需格式的 Web 應用。

## 1. 使用者旅程（User Journey）

1) 輸入 URL（主要行動）
- 元件：大型輸入框（支持多行，多 URL 每行一個）+ 主要 CTA「開始轉換」
- 附件功能：上傳文字檔（批量 URL）、基本 URL 格式驗證

2) 配置設定（預設隱藏，展開為高級選項）
- 輸出格式：Parquet（預設/推薦）、CSV、JSON、Markdown
- 內容提取：智能提取正文（推薦）/ 全文 HTML
- 清洗選項：移除廣告、相對連結→絕對連結、提取作者/時間等 metadata
- Parquet 高級：壓縮（Snappy/Gzip）、分區欄位

3) 處理中狀態（透明回饋）
- 總體進度條：下載 → 解析 → 轉換 → 完成
- 即時日誌：可折疊視窗顯示後端日誌（抓取、提取字數、輸出生成等）
- 即時通訊：SSE 或 WebSocket 推播進度與階段事件

4) 結果預覽與下載
- 成功訊息 + 檔案摘要（大小、列數）
- 預覽分頁：表格（CSV/Parquet 篩選/排序/分頁）、JSON、Markdown 原文
- 下載按鈕：「下載 {格式}」
- 快捷：再次轉換 / 回首頁

5) 失敗與局部成功（優雅降級）
- 列示失敗 URL 與錯誤原因（例如 404、解析失敗）
- 成功的結果可正常下載
- 行動：重試失敗 URL、下載錯誤報告

6) 進階（選配）
- 歷史記錄：登入用戶可查看與重下歷史結果
- API 調用：提供對應 curl 指令與 API 樣例

## 2. 前端 UI/UX 與現有組件對照

現有區塊（參見 `frontend/src`）
- 頂部：`Header`
- 左側導覽：`ActivityBar`
- 主內容：`Dashboard`、`OperationsDashboard`、`MetricsOverview`、`Settings` 等

新增/擴充建議
- 新頁/卡片：`UrlToParquetWizard`
  - Step 1：URL 輸入框 + 批量上傳
  - Step 2：`AdvancedOptionsPanel`（輸出格式/提取/清洗/Parquet 高級）
  - Step 3：`JobProgressPanel`（進度條 + 日誌）
  - Step 4：`ResultPreview`（表格/JSON/Markdown 預覽 + 下載區）
- 共用 UI：沿用 `components/ui/*`（`Button`, `Card`, `Input`, `Spin`, `Typography`）
- 圖表/指標：沿用 `MetricsOverview` 的視覺語彙

導覽
- 在 `ActivityBar` 新增項目：`url2parquet`（文案：URL 轉換）

## 3. 後端/ETL 流程映射

期望端點
- POST `/api/url2parquet/jobs`：提交轉換請求（單/多 URL 或上傳檔）
- GET `/api/url2parquet/jobs/{job_id}`：查詢狀態與進度
- GET `/api/url2parquet/jobs/{job_id}/logs`：串流日誌（SSE/WebSocket）
- GET `/api/url2parquet/jobs/{job_id}/download?format=parquet|csv|json|md`

對應現有模組
- HTML→MD：`src/html_to_markdown`（增 `ingest.py`、`watcher.py` 與統一 pipeline 入口）
- ETL API：`src/etl/etl_api.py`（新增 job 類型 `URL2PARQUET`，封裝 E→T→L 與驗證）
- 統一輸出：標準 JSON schema（metadata/content/files/validation），再派生 CSV/Parquet

去重與冪等
- Extract 階段計算 checksum（sha256），重複任務直接短路/復用成果

錯誤與重試
- 類別化（網路/解析/編碼/引擎），退避重試；轉換引擎降級（markdownify→trafilatura→html2text）

可觀測性
- Prometheus 指標：成功/失敗/重試次數、延遲分位數、引擎占比、job 狀態分佈

## 4. 資料格式與預覽

標準輸出 JSON（建議欄位）
- metadata：id, source_url, source_type, checksum, timestamp, engine_used, processing_stats, warnings
- content：markdown, title, summary, language, tags
- files：output_files, artifact_versions
- validation：overall_score, issues

派生輸出
- CSV：平鋪欄位（title/summary/markdown…）
- Parquet：依照資料表欄位定義（支援壓縮/分區）

前端預覽
- 表格預覽：以虛擬清單分頁；JSON/Markdown 使用程式碼區塊/渲染器

## 5. 狀態同步與即時回饋

- 短任務：直接輪詢（2–3s/次）
- 長任務：SSE 或 WebSocket，事件：queued/started/phase_update/progress/log/completed/failed
- 前端以 `JobProgressPanel` 訂閱事件更新 UI

## 6. 權限、歷史與可追蹤

- 登入用戶：保存歷史 job（URL、選項、產出、時間）
- 下載權限：僅限提交者或同組織（之後可接入 RBAC）
- 問題追蹤：失敗快照（輸入/日誌/例外）供支援與重現

## 7. 效能與成本考量

- 批次壓力：任務佇列（Redis + RQ/Celery）限制並發；大批量拆分子任務
- 緩存：同 URL/相同選項命中緩存直接回應
- 產出壓縮：Parquet Snappy 預設；大檔案提供分段下載

## 8. 可及性（A11y）與多語

- 表單/按鈕具備 aria-label、鍵盤可達；高對比色系
- 文案國際化（i18n），中英切換

## 9. 交付清單（MVP）

- 前端
  - `UrlToParquetWizard`（四步）與子元件（Options/Progress/Preview）
  - `ActivityBar` 新增入口
- 後端
  - ETL job 類型 `URL2PARQUET` + 統一 pipeline 入口
  - 端點：提交/狀態/下載 + SSE/WebSocket 日誌
  - 輸出：JSON/CSV/Parquet（含 schema 與壓縮）
- 文件
  - README 追加入門指引與 API 样例
  - Schema 說明與錯誤碼對照

## 10. 里程碑與風險

- 里程碑：
  1) 流程與 schema 打通 → 2) 單 URL MVP → 3) 批次 URL + 歷史 → 4) SSE/WebSocket 與進階選項
- 風險：
  - 特殊站點（反爬/JS 渲染）抽取不穩 → Playwright 兜底（成本較高）
  - 超大頁面與極長 Markdown 的表格預覽效能 → 虛擬化與截取預覽

—

附註：前端現況與區塊對照可參考《頁面分布說明書_2025-09-08.md》，專案 Issues 規劃請見 [GitHub Issues](https://github.com/jason660519/Proxy-Crawler-System/issues).
